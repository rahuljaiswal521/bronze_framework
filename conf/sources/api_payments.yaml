name: payments
source_type: api
description: "Payment gateway REST API - daily transaction pull"
enabled: true
tags:
  domain: finance
  source_system: payment_gateway
  priority: high

extract:
  load_type: incremental
  base_url: https://api.paymentgateway.com
  endpoint: /v2/transactions
  method: GET
  timeout_seconds: 60
  max_retries: 3
  retry_backoff_factor: 2.0
  response_root_path: transactions
  params:
    status: completed
  watermark:
    column: updated_at
    type: timestamp
    default_value: "2024-01-01T00:00:00Z"
  auth:
    type: oauth2
    secret_scope: ${secret_scope}
    secret_key_client_id: payment-api-client-id
    secret_key_client_secret: payment-api-client-secret
    token_url: https://auth.paymentgateway.com/oauth/token
  pagination:
    type: cursor
    page_size: 500
    max_pages: 100
    cursor_param: cursor
    cursor_response_path: meta.next_cursor
    data_response_path: transactions

target:
  catalog: ${catalog}
  schema: bronze
  table: payment_transactions
  partition_by:
    - _ingest_date
  table_properties:
    delta.autoOptimize.optimizeWrite: "true"
  metadata_columns:
    - name: _ingest_timestamp
      expression: "current_timestamp()"
    - name: _ingest_date
      expression: "current_date()"
    - name: _source_system
      expression: "'payment_gateway'"
    - name: _source_file
      expression: "lit('api:payments')"
  schema_evolution:
    mode: merge
  quality:
    enabled: true
    quarantine_threshold_pct: 2.0
  cdc:
    enabled: true
    mode: scd2
    primary_keys:
      - transaction_id
    sequence_column: updated_at
    exclude_columns_from_hash:
      - _ingest_timestamp
      - _ingest_date
      - _source_file
      - updated_at
